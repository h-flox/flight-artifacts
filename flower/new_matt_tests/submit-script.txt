#!/bin/bash
#SBATCH --job-name="flower-test"
#SBATCH --output="flower-test-out.152.single.out"
#SBATCH --partition=compute
#SBATCH --nodes=2
#SBATCH --ntasks-per-node=1
#SBATCH --mem=240G 
#SBATCH --account=chi150
#SBATCH --export=ALL
#SBATCH -t 00:30:00

export NODES=$SLURM_JOB_NUM_NODES
ipad=$(hostname -I | awk '{print $3}')
echo $ipad
module load anaconda3/2021.05
conda activate flower_scale
for num_workers in 1 2 4 8 16 32 64 128
do

	timeout 600 python ~/kyle/flower/server.py --clients $num_workers --ip $ipad --model 152 & 

	srun --ntasks 1 -l --exclude=$SLURMD_NODENAME ~/kyle/flower/client-run.sh $num_workers 152 $ipad
	wait
done
